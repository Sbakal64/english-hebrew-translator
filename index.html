<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced English-Hebrew Translator</title>
    <script src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        .translation-tooltip {
            position: absolute;
            background: white;
            border: 1px solid #ccc;
            padding: 8px;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        function App() {
            const [inputText, setInputText] = React.useState('');
            const [translatedText, setTranslatedText] = React.useState('');
            const [isLoading, setIsLoading] = React.useState(false);
            const [error, setError] = React.useState(null);
            const [translationHistory, setTranslationHistory] = React.useState([]);
            const [apiUsed, setApiUsed] = React.useState('');
            const [selectedText, setSelectedText] = React.useState('');
            const [tooltipPosition, setTooltipPosition] = React.useState({ x: 0, y: 0 });
            const [partialTranslation, setPartialTranslation] = React.useState('');
            const cancelToken = React.useRef(null);

            // Translation endpoints
            const FREE_TRANSLATION_ENDPOINTS = [/* Your endpoints here */];

            // Cancel ongoing translation when input changes
            React.useEffect(() => {
                return () => {
                    if (cancelToken.current) {
                        cancelToken.current.cancel('User cancelled translation');
                    }
                };
            }, []);

            // Handle text selection
            const handleTextSelection = (e) => {
                const selection = window.getSelection().toString().trim();
                if (selection.length > 0) {
                    const range = window.getSelection().getRangeAt(0);
                    const rect = range.getBoundingClientRect();
                    setTooltipPosition({
                        x: rect.left + window.scrollX,
                        y: rect.top + window.scrollY - 40
                    });
                    setSelectedText(selection);
                    translatePartialText(selection);
                }
            };

            // Translate selected text
            const translatePartialText = async (text) => {
                try {
                    const response = await axios.post(FREE_TRANSLATION_ENDPOINTS[0], {
                        q: text,
                        source: 'en',
                        target: 'he'
                    });
                    setPartialTranslation(response.data.translatedText);
                } catch (error) {
                    console.error('Partial translation failed:', error);
                }
            };

            // Improved translation function with cancellation
            const debouncedTranslate = React.useCallback(
                _.debounce(async (text) => {
                    if (!text.trim()) {
                        setTranslatedText('');
                        setError(null);
                        return;
                    }

                    setIsLoading(true);
                    setError(null);
                    cancelToken.current = axios.CancelToken.source();

                    try {
                        for (let endpoint of FREE_TRANSLATION_ENDPOINTS) {
                            try {
                                const response = await axios.post(endpoint, {
                                    q: text,
                                    source: 'en',
                                    target: 'he'
                                }, {
                                    cancelToken: cancelToken.current.token,
                                    timeout: 5000 // 5-second timeout
                                });

                                if (response.data.translatedText) {
                                    setTranslatedText(response.data.translatedText);
                                    setTranslationHistory(prev => [{
                                        original: text,
                                        translation: response.data.translatedText,
                                        timestamp: new Date().toLocaleString()
                                    }, ...prev].slice(0, 10));
                                    return;
                                }
                            } catch (err) {
                                if (!axios.isCancel(err)) {
                                    console.warn(`Endpoint failed: ${endpoint}`, err);
                                }
                            }
                        }
                        throw new Error('All translation endpoints failed');
                    } catch (err) {
                        if (!axios.isCancel(err)) {
                            setError(err.message);
                        }
                    } finally {
                        setIsLoading(false);
                    }
                }, 500),
                []
            );

            React.useEffect(() => {
                if (inputText) {
                    debouncedTranslate(inputText);
                } else {
                    setTranslatedText('');
                }
            }, [inputText, debouncedTranslate]);

            const copyToClipboard = (text) => {
                if (!text) return;
                navigator.clipboard.writeText(text).then(() => {
                    alert('Copied to clipboard!');
                });
            };

            return (
                <div className="container mx-auto p-6 max-w-4xl">
                    <h1 className="text-3xl font-bold mb-6 text-center">Enhanced English-Hebrew Translator</h1>
                    
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label htmlFor="input-text" className="block mb-2 font-semibold">English Text</label>
                            <textarea 
                                id="input-text"
                                value={inputText}
                                onChange={(e) => {
                                    if (cancelToken.current) {
                                        cancelToken.current.cancel('User modified text');
                                    }
                                    setInputText(e.target.value);
                                }}
                                className="w-full h-64 p-3 border rounded-lg"
                                placeholder="Enter text to translate..."
                                onMouseUp={handleTextSelection}
                                onKeyUp={handleTextSelection}
                            />
                        </div>
                        
                        <div>
                            <label htmlFor="translated-text" className="block mb-2 font-semibold">Hebrew Translation</label>
                            <div className="relative">
                                <textarea 
                                    id="translated-text"
                                    value={translatedText}
                                    readOnly
                                    className="w-full h-64 p-3 border rounded-lg bg-gray-100"
                                    placeholder="Translation will appear here..."
                                />
                                <button 
                                    onClick={() => copyToClipboard(translatedText)}
                                    className="absolute top-2 right-2 bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 transition-colors"
                                    style={{ zIndex: 10 }}
                                >
                                    Copy
                                </button>
                                {isLoading && (
                                    <div className="absolute inset-0 bg-gray-100 bg-opacity-50 flex items-center justify-center">
                                        <div className="spinner-border animate-spin inline-block w-8 h-8 border-4 rounded-full" role="status">
                                            <span className="visually-hidden">Loading...</span>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>

                    {selectedText && (
                        <div 
                            className="translation-tooltip" 
                            style={{ 
                                left: `${tooltipPosition.x}px`,
                                top: `${tooltipPosition.y}px`
                            }}
                        >
                            <div className="font-bold mb-2">Selected Text:</div>
                            <div className="mb-2">{selectedText}</div>
                            <div className="font-bold">Translation:</div>
                            <div dir="rtl">{partialTranslation}</div>
                        </div>
                    )}

                    {/* Translation History remains same */}
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
